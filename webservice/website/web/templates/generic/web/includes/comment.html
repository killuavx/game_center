{% load mezzanine_tags comment_tags comment_star_tags web_tags %}
{% for comment in comments %}
    {% if not comment.is_removed %}
<div class="review_list" id="comment-{{ comment.id }}" onmouseout="comment_hide_toolbar(this);" onmouseover="comment_show_toolbar(this);">
    {% comment %}
    {% if not comment.is_removed and comment.is_public or request.user.is_staff %}
    <span class="status" data-status="{{ comment.is_removed|yesno:'r,' }},{{ comment.is_public|yesno:'p,' }}">
        <a href="javascript:;" class="remove">删除</a> | <a href="javascript:;" class="public">发布</a>
    </span>
    {% endif %}
    {% editable comment.is_public comment.is_removed %}
    {% endcomment %}
    <dl class="cb">
        <dt class="ios-web-icon l user" title="{{ comment.user.username }}">
            {% if comment.user.profile.icon %}
            <img src="{{ comment.user.profile.icon.url }}" />
            {% else %}
            <img src="{% gravatar_url comment.email %}" />
            {% endif %}
        </dt>
        <dd class="d1">
            <span class="ios-web-icon l star s{{ comment|comment_content_star_value }}"></span>
            <span class="ml10 rl-user">{{ comment.user.username }}</span>
            <span class="r">{{ comment.submit_date|date:'Y-m-d H:i' }}</span></dd>
        <dd class="d2">{{ comment.comment|comment_filter }}</dd>

        <dd class="d3">
            {% if request.user.is_authenticated %}
            {% if request.user.is_staff %}
            <a title="删除" href="javascript:remove_comment({{ comment.pk }});" class="r4"><span class="ios-web-icon"></span>删除</a>
            {% endif %}{% comment %}
            <a title="举报" href="javascript:;" onclick="report_comment({{ comment.pk }});" class="r3"><span class="ios-web-icon"></span>举报</a>
            <a title="回复" href="javascript:;" onclick="reply_comment({{ comment.pk }});" class="r2"><span class="ios-web-icon"></span>1</a>
            <a title="赞" href="javascript:;" onclick="vote_comment({{ comment.pk }});" class="r1"><span class="ios-web-icon"></span>0</a>
            {% endcomment %}
            {% endif %}
        </dd>

    </dl>
    <div class="cl"></div>
    {% if not comment.is_removed and comment.is_public or request.user.is_staff %}{% endif %}
</div>
    {% endif %}
{% endfor %}
{% if with_paginator %}{% pagination_ajax comments_page paginator_url=comment_list_url load_selector='#comment-list' %}{% endif %}
{% if no_comments %}
{% else %}
{% endif %}
<script type="text/javascript">
    function comment_show_toolbar(dom){
        $(dom).find('dd.d3').find('.r3,.r4').show()
    }
    function comment_hide_toolbar(dom){
        $(dom).find('dd.d3').find('.r3,.r4').hide()
    }
    {% if request.user.is_authenticated %}
    {% if request.user.is_staff %}
    function remove_comment(id){
        $.ajax({
            url:'/comment/remove/' + id,
            type:'get',
            dataType:'json',
            success:function(data){
                if(data.code != 0) {
                    alert(data.msg);
                } else {
                   var cmtlist = $('#comment-list');
                   var cmtlist_page = cmtlist.find('.page');
                   page_load('#comment-list',
                           cmtlist_page,
                           cmtlist_page.attr('data-page'));
                }
            }
        });
    }
    {% endif %}{% comment %}
    function report_comment(id){

    }
    function reply_comment(id){

    }
    function vote_comment(id){

    }
    {% endcomment %}
    {% endif %}
</script>
